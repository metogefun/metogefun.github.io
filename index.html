<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.1" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.1">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.1" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.4.1',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Seven times I have despised my soul">
<meta name="keywords" content="Java JVM 架构 高可用">
<meta property="og:type" content="website">
<meta property="og:title" content="王召辉">
<meta property="og:url" content="http://blog.finegames.cn/index.html">
<meta property="og:site_name" content="王召辉">
<meta property="og:description" content="Seven times I have despised my soul">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="王召辉">
<meta name="twitter:description" content="Seven times I have despised my soul">






  <link rel="canonical" href="http://blog.finegames.cn/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>王召辉</title>
  






  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?35df2910988f3ac3b6282457c46b775c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">王召辉</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.finegames.cn/2018/09/10/new-blog-theme/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王召辉">
      <meta itemprop="description" content="Seven times I have despised my soul">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王召辉">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/10/new-blog-theme/" itemprop="url">
                  使用hexo和NexT搭建博客
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-09-10 18:30:18 / 修改时间：18:38:50" itemprop="dateCreated datePublished" datetime="2018-09-10T18:30:18+08:00">2018-09-10</time>
            

            
              

              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/10/new-blog-theme/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/10/new-blog-theme/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/09/10/new-blog-theme/" class="leancloud_visitors" data-flag-title="使用hexo和NexT搭建博客">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>有时候有些东西看久了，还是应该适当的调整下，比如博客~</p>
<p>最近看到别人家的blog通过<a href="https://hexo.io/zh-cn/" target="_blank" rel="noopener">hexo</a>和<a href="http://theme-next.iissnan.com/" target="_blank" rel="noopener">NexT</a>进行设计，遂也动心做下改版。</p>
<p>上面是两个东西的中文文档，按照教程操作还是比较快的。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.finegames.cn/2018/06/13/ali-nonuse-zk/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王召辉">
      <meta itemprop="description" content="Seven times I have despised my soul">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王召辉">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/13/ali-nonuse-zk/" itemprop="url">
                  (转载）阿里巴巴为什么不用 ZooKeeper 做服务发现？
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-06-13 22:16:42" itemprop="dateCreated datePublished" datetime="2018-06-13T22:16:42+08:00">2018-06-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-09-10 22:41:51" itemprop="dateModified" datetime="2018-09-10T22:41:51+08:00">2018-09-10</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/zookeeper/" itemprop="url" rel="index"><span itemprop="name">zookeeper</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/06/13/ali-nonuse-zk/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/06/13/ali-nonuse-zk/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/06/13/ali-nonuse-zk/" class="leancloud_visitors" data-flag-title="(转载）阿里巴巴为什么不用 ZooKeeper 做服务发现？">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文转载自<a href="http://www.infoq.com/cn/articles/why-doesnot-alibaba-use-zookeeper" target="_blank" rel="noopener">infoq</a></p>
<p>站在未来的路口，回望历史的迷途，常常会很有意思，因为我们会不经意地兴起疯狂的念头，例如如果当年某事提前发生了，而另外一件事又没有发生会怎样？一如当年的奥匈帝国皇位继承人斐迪南大公夫妇如果没有被塞尔维亚族热血青年普林西普枪杀会怎样，又如若当年的丘老道没有经过牛家村会怎样？</p>
<p>2008 年底，淘宝开启一个叫做“五彩石”的内部重构项目，这个项目后来成为了淘宝服务化、面向分布式走自研之路，走出了互联网中间件体系之始，而淘宝服务注册中心 ConfigServer 于同年诞生。</p>
<p>2008 年前后，Yahoo 这个曾经的互联网巨头开始逐渐在公开场合宣讲自己的大数据分布式协调产品 ZooKeeper，这个产品参考了 Google 发表的关于 Chubby 以及 Paxos 的论文。</p>
<p>2010 年 11 月，ZooKeeper 从 Apache Hadoop 的子项目发展为 Apache 的顶级项目，正式宣告 ZooKeeper 成为一个工业级的成熟稳定的产品。</p>
<p>2011 年，阿里巴巴开源 Dubbo，为了更好开源，需要剥离与阿里内部系统的关系，Dubbo 支持了开源的 ZooKeeper 作为其注册中心，后来在国内，在业界诸君的努力实践下，Dubbo + ZooKeeper 的典型的服务化方案成就了 ZooKeeper 作为注册中心的声名。</p>
<p>2015 年双 11，ConfigServer 服务内部近 8 个年头过去了，阿里巴巴内部“服务规模”超几百万 ，以及推进“千里之外”的 IDC 容灾技术战略等，共同促使阿里巴巴内部开启了 ConfigServer 2.0 到 ConfigServer 3.0 的架构升级之路。</p>
<p>时间走向 2018 年，站在 10 年的时间路口上，有多少人愿意在追逐日新月异的新潮技术概念的时候，稍微慢一下脚步，仔细凝视一下服务发现这个领域，有多少人想到过或者思考过一个问题：</p>
<h1 id="服务发现，ZooKeeper-真的是最佳选择么？"><a href="#服务发现，ZooKeeper-真的是最佳选择么？" class="headerlink" title="服务发现，ZooKeeper 真的是最佳选择么？"></a>服务发现，ZooKeeper 真的是最佳选择么？</h1><p>而回望历史，我们也偶有迷思，在服务发现这个场景下，如果当年 ZooKeeper 的诞生之日比我们 HSF 的注册中心 ConfigServer 早一点会怎样？</p>
<p>我们会不会走向先使用 ZooKeeper 然后疯狂改造与修补 ZooKeeper 以适应阿里巴巴的服务化场景与需求的弯路？</p>
<p>但是，站在今天和前人的肩膀上，我们从未如今天这样坚定的认知到，在服务发现领域，ZooKeeper 根本就不能算是最佳的选择，一如这些年一直与我们同行的 Eureka 以及这篇文章 《Eureka! Why You Shouldn’t Use ZooKeeper for Service Discovery》那坚定的阐述一样，为什么你不应该用 ZooKeeper 做服务发现！</p>
<p>吾道不孤矣。</p>
<h1 id="注册中心需求分析及关键设计考量"><a href="#注册中心需求分析及关键设计考量" class="headerlink" title="注册中心需求分析及关键设计考量"></a>注册中心需求分析及关键设计考量</h1><p>接下来，让我们回归对服务发现的需求分析，结合阿里巴巴在关键场景上的实践，来一一分析，一起探讨为何说 ZooKeeper 并不是最合适的注册中心解决方案。</p>
<h2 id="注册中心是-CP-还是-AP-系统"><a href="#注册中心是-CP-还是-AP-系统" class="headerlink" title="注册中心是 CP 还是 AP 系统?"></a>注册中心是 CP 还是 AP 系统?</h2><p>CAP 和 BASE 理论相信读者都已经耳熟能详，其业已成了指导分布式系统及互联网应用构建的关键原则之一，在此不再赘述其理论，我们直接进入对注册中心的数据一致性和可用性需求的分析:</p>
<h3 id="数据一致性需求分析"><a href="#数据一致性需求分析" class="headerlink" title="数据一致性需求分析"></a>数据一致性需求分析</h3><p>注册中心最本质的功能可以看成是一个 Query 函数 Si = F(service-name)，以 service-name 为查询参数，service-name 对应的服务的可用的 endpoints (ip:port)列表为返回值.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注: 后文将 service 简写为 svc。</span><br></pre></td></tr></table></figure>
<p>先来看看关键数据 endpoints (ip:port) 不一致性带来的影响，即 CAP 中的 C 不满足带来的后果 :</p>
<img src="/2018/06/13/ali-nonuse-zk/call-flow.png" title="call flow">
<p>如上图所示，如果一个 svcB 部署了 10 个节点 (副本 /Replica），如果对于同一个服务名 svcB, 调用者 svcA 的 2 个节点的 2 次查询返回了不一致的数据，例如: S1 = { ip1,ip2,ip3…,ip9 }, S2 = { ip2,ip3,….ip10 }, 那么这次不一致带来的影响是什么？相信你一定已经看出来了，svcB 的各个节点流量会有一点不均衡。</p>
<p>ip1 和 ip10 相对其它 8 个节点{ip2…ip9}，请求流量小了一点，但很明显，在分布式系统中，即使是对等部署的服务，因为请求到达的时间，硬件的状态，操作系统的调度，虚拟机的 GC 等，任何一个时间点，这些对等部署的节点状态也不可能完全一致，而流量不一致的情况下，只要注册中心在 SLA 承诺的时间内（例如 1s 内）将数据收敛到一致状态（即满足最终一致），流量将很快趋于统计学意义上的一致，所以注册中心以最终一致的模型设计在生产实践中完全可以接受。</p>
<h3 id="分区容忍及可用性需求分析"><a href="#分区容忍及可用性需求分析" class="headerlink" title="分区容忍及可用性需求分析"></a>分区容忍及可用性需求分析</h3><p>接下来我们看一下网络分区（Network Partition）情况下注册中心不可用对服务调用产生的影响，即 CAP 中的 A 不满足时带来的影响。</p>
<p>考虑一个典型的 ZooKeeper 三机房容灾 5 节点部署结构 (即 2-2-1 结构)，如下图:</p>

<p>当机房 3 出现网络分区 (Network Partitioned) 的时候，即机房 3 在网络上成了孤岛，我们知道虽然整体 ZooKeeper 服务是可用的，但是节点 ZK5 是不可写的，因为联系不上 Leader。</p>
<p>也就是说，这时候机房 3 的应用服务 svcB 是不可以新部署，重新启动，扩容或者缩容的，但是站在网络和服务调用的角度看，机房 3 的 svcA 虽然无法调用机房 1 和机房 2 的 svcB, 但是与机房 3 的 svcB 之间的网络明明是 OK 的啊，为什么不让我调用本机房的服务？</p>
<p>现在因为注册中心自身为了保脑裂 (P) 下的数据一致性（C）而放弃了可用性，导致了同机房的服务之间出现了无法调用，这是绝对不允许的！可以说在实践中，注册中心不能因为自身的任何原因破坏服务之间本身的可连通性，这是注册中心设计应该遵循的铁律！ 后面在注册中心客户端灾容上我们还会继续讨论。</p>
<p>同时我们再考虑一下这种情况下的数据不一致性，如果机房 1，2，3 之间都成了孤岛，那么如果每个机房的 svcA 都只拿到本机房的 svcB 的 ip 列表，也即在各机房 svcB 的 ip 列表数据完全不一致，影响是什么？</p>
<p>其实没啥大影响，只是这种情况下，全都变成了同机房调用，我们在设计注册中心的时候，有时候甚至会主动利用这种注册中心的数据可以不一致性，来帮助应用主动做到同机房调用，从而优化服务调用链路 RT 的效果！</p>
<p>通过以上我们的阐述可以看到，在 CAP 的权衡中，注册中心的可用性比数据强一致性更宝贵，所以整体设计更应该偏向 AP，而非 CP，数据不一致在可接受范围，而 P 下舍弃 A 却完全违反了注册中心不能因为自身的任何原因破坏服务本身的可连通性的原则。</p>
<h2 id="服务规模、容量、服务联通性"><a href="#服务规模、容量、服务联通性" class="headerlink" title="服务规模、容量、服务联通性"></a>服务规模、容量、服务联通性</h2><p>你所在公司的“微服务”规模有多大？数百微服务？部署了上百个节点？那么 3 年后呢？互联网是产生奇迹的地方，也许你的“服务”一夜之间就家喻户晓，流量倍增，规模翻番！</p>
<p>当数据中心服务规模超过一定数量 (服务规模 =F{服务 pub 数, 服务 sub 数})，作为注册中心的 ZooKeeper 很快就会像下图的驴子一样不堪重负</p>
<img src="/2018/06/13/ali-nonuse-zk/dem.png" title="dem">
<p>其实当 ZooKeeper 用对地方时，即用在粗粒度分布式锁，分布式协调场景下，ZooKeeper 能支持的 tps 和支撑的连接数是足够用的，因为这些场景对于 ZooKeeper 的扩展性和容量诉求不是很强烈。</p>
<p>但在服务发现和健康监测场景下，随着服务规模的增大，无论是应用频繁发布时的服务注册带来的写请求，还是刷毫秒级的服务健康状态带来的写请求，还是恨不能整个数据中心的机器或者容器皆与注册中心有长连接带来的连接压力上，ZooKeeper 很快就会力不从心，而 ZooKeeper 的写并不是可扩展的，不可以通过加节点解决水平扩展性问题。</p>
<p>要想在 ZooKeeper 基础上硬着头皮解决服务规模的增长问题，一个实践中可以考虑的方法是想办法梳理业务，垂直划分业务域，将其划分到多个 ZooKeeper 注册中心，但是作为提供通用服务的平台机构组，因自己提供的服务能力不足要业务按照技术的指挥棒配合划分治理业务，真的可行么？</p>
<p>而且这又违反了因为注册中心自身的原因（能力不足）破坏了服务的可连通性，举个简单的例子，1 个搜索业务，1 个地图业务，1 个大文娱业务，1 个游戏业务，他们之间的服务就应该老死不相往来么？也许今天是肯定的，那么明天呢，1 年后呢，10 年后呢？谁知道未来会要打通几个业务域去做什么奇葩的业务创新？注册中心作为基础服务，无法预料未来的时候当然不能妨碍业务服务对未来固有联通性的需求。</p>
<h2 id="注册中心需要持久存储和事务日志么？"><a href="#注册中心需要持久存储和事务日志么？" class="headerlink" title="注册中心需要持久存储和事务日志么？"></a>注册中心需要持久存储和事务日志么？</h2><p>需要，也不需要。</p>
<p>我们知道 ZooKeeper 的 ZAB 协议对每一个写请求，会在每个 ZooKeeper 节点上保持写一个事务日志，同时再加上定期的将内存数据镜像（Snapshot）到磁盘来保证数据的一致性和持久性，以及宕机之后的数据可恢复，这是非常好的特性，但是我们要问，在服务发现场景中，其最核心的数据 - 实时的健康的服务的地址列表真的需要数据持久化么？</p>
<p>对于这份数据，答案是否定的。</p>
<img src="/2018/06/13/ali-nonuse-zk/txnlog.png" title="txnlog">
<p>如上图所示，如果 svcB 经历了注册服务 (ip1) 到扩容到 2 个节点（ip1，ip2）到因宕机缩容 (ip1 宕机），这个过程中，产生了 3 次针对 ZooKeeper 的写操作。</p>
<p>但是仔细分析，通过事务日志，持久化连续记录这个变化过程其实意义不大，因为在服务发现中，服务调用发起方更关注的是其要调用的服务的实时的地址列表和实时健康状态，每次发起调用时，并不关心要调用的服务的历史服务地址列表、过去的健康状态。</p>
<p>但是为什么又说需要呢，因为一个完整的生产可用的注册中心，除了服务的实时地址列表以及实时的健康状态之外，还会存储一些服务的元数据信息，例如服务的版本，分组，所在的数据中心，权重，鉴权策略信息，service label 等元信息，这些数据需要持久化存储，并且注册中心应该提供对这些元信息的检索的能力。</p>
<h2 id="Service-Health-Check"><a href="#Service-Health-Check" class="headerlink" title="Service Health Check"></a>Service Health Check</h2><p>使用 ZooKeeper 作为服务注册中心时，服务的健康检测常利用 ZooKeeper 的 Session 活性 Track 机制 以及结合 Ephemeral ZNode 的机制，简单而言，就是将服务的健康监测绑定在了 ZooKeeper 对于 Session 的健康监测上，或者说绑定在 TCP 长链接活性探测上了。</p>
<p>这在很多时候也会造成致命的问题，ZK 与服务提供者机器之间的 TCP 长链接活性探测正常的时候，该服务就是健康的么？答案当然是否定的！注册中心应该提供更丰富的健康监测方案，服务的健康与否的逻辑应该开放给服务提供方自己定义，而不是一刀切搞成了 TCP 活性检测！</p>
<p>健康检测的一大基本设计原则就是尽可能真实的反馈服务本身的真实健康状态，否则一个不敢被服务调用者相信的健康状态判定结果还不如没有健康检测。</p>
<h2 id="注册中心的容灾考虑"><a href="#注册中心的容灾考虑" class="headerlink" title="注册中心的容灾考虑"></a>注册中心的容灾考虑</h2><p>前文提过，在实践中，注册中心不能因为自身的任何原因破坏服务之间本身的可连通性，那么在可用性上，一个本质的问题，如果注册中心（Registry）本身完全宕机了，svcA 调用 svcB 链路应该受到影响么？</p>
<img src="/2018/06/13/ali-nonuse-zk/resiliency.png" title="resiliency">
<p>是的，不应该受到影响。</p>
<p>服务调用（请求响应流）链路应该是弱依赖注册中心，必须仅在服务发布，机器上下线，服务扩缩容等必要时才依赖注册中心。</p>
<p>这需要注册中心仔细的设计自己提供的客户端，客户端中应该有针对注册中心服务完全不可用时做容灾的手段，例如设计客户端缓存数据机制（我们称之为 client snapshot）就是行之有效的手段。另外，注册中心的 health check 机制也要仔细设计以便在这种情况不会出现诸如推空等情况的出现。</p>
<p>ZooKeeper 的原生客户端并没有这种能力，所以利用 ZooKeeper 实现注册中心的时候我们一定要问自己，如果把 ZooKeeper 所有节点全干掉，你生产上的所有服务调用链路能不受任何影响么？而且应该定期就这一点做故障演练。</p>
<p>##你有没有 ZooKeeper 的专家可依靠？</p>
<p>ZooKeeper 看似很简单的一个产品，但在生产上大规模使用并且用好，并不是那么理所当然的事情。如果你决定在生产中引入 ZooKeeper，你最好做好随时向 ZooKeeper 技术专家寻求帮助的心理预期，最典型的表现是在两个方面:</p>
<h3 id="难以掌握的-Client-Session-状态机"><a href="#难以掌握的-Client-Session-状态机" class="headerlink" title="难以掌握的 Client/Session 状态机"></a>难以掌握的 Client/Session 状态机</h3><p>ZooKeeper 的原生客户端绝对称不上好用，Curator 会好一点，但其实也好的有限，要完全理解 ZooKeeper 客户端与 Server 之间的交互协议也并不简单，完全理解并掌握 ZooKeeper Client/Session 的状态机（下图）也并不是那么简单明了:</p>

<p>但基于 ZooKeeper 的服务发现方案却是依赖 ZooKeeper 提供的长连接 /Session 管理，Ephemeral ZNode，Event&amp;Notification, ping 机制上，所以要用好 ZooKeeper 做服务发现，恰恰要理解这些 ZooKeeper 核心的机制原理，这有时候会让你陷入暴躁，我只是想要个服务发现而已，怎么要知道这么多？而如果这些你都理解了并且不踩坑，恭喜你，你已经成为 ZooKeeper 的技术专家了。</p>
<h3 id="难以承受的异常处理"><a href="#难以承受的异常处理" class="headerlink" title="难以承受的异常处理"></a>难以承受的异常处理</h3><p>我们在阿里巴巴内部应用接入 ZooKeeper 时，有一个《ZooKeeper 应用接入必知必会》的 WIKI，其中关于异常处理有过如下的论述:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">如果说要选出应用开发者在使用 ZooKeeper 的过程中，最需要了解清楚的事情？那么根据我们之前的支持经验，一定是异常处理。</span><br><span class="line"></span><br><span class="line">当所有一切（宿主机，磁盘，网络等等）都很幸运的正常工作的时候，应用与 ZooKeeper 可能也会运行的很好，但不幸的是，我们整天会面对各种意外，而且这遵循墨菲定律，意料之外的坏事情总是在你最担心的时候发生。</span><br><span class="line"></span><br><span class="line">所以务必仔细了解 ZooKeeper 在一些场景下会出现的异常和错误，确保您正确的理解了这些异常和错误，以及知道您的应用如何正确的处理这些情况。</span><br><span class="line"></span><br><span class="line">ConnectionLossException 和 Disconnected 事件</span><br><span class="line"></span><br><span class="line">简单来说，这是个可以在同一个 ZooKeeper Session 恢复的异常 (Recoverable), 但是应用开发者需要负责将应用恢复到正确的状态。</span><br><span class="line"></span><br><span class="line">发生这个异常的原因有很多，例如应用机器与 ZooKeeper 节点之间网络闪断，ZooKeeper 节点宕机，服务端 Full GC 时间超长，甚至你的应用进程 Hang 死，应用进程 Full GC 时间超长之后恢复都有可能。</span><br><span class="line"></span><br><span class="line">要理解这个异常，需要了解分布式应用中的一个典型的问题，如下图：</span><br><span class="line"></span><br><span class="line">&#123;% asset_img client-server.png client server %&#125;</span><br><span class="line"></span><br><span class="line">在一个典型的客户端请求、服务端响应中，当它们之间的长连接闪断的时候，客户端感知到这个闪断事件的时候，会处在一个比较尴尬的境地，那就是无法确定该事件发生时附近的那个请求到底处在什么状态，Server 端到底收到这个请求了么？已经处理了么？因为无法确定这一点，所以当客户端重新连接上 Server 之后，这个请求是否应该重试（Retry）就也要打一个问号。</span><br><span class="line"></span><br><span class="line">所以在处理连接断开事件中，应用开发者必须清楚处于闪断附近的那个请求是什么（这常常难以判断），该请求是否是幂等的，对于业务请求在 Server 端服务处理上对于&quot;仅处理一次&quot; &quot;最多处理一次&quot; &quot;最少处理一次&quot;语义要有选择和预期。</span><br><span class="line"></span><br><span class="line">举个例子，如果应用在收到 ConnectionLossException 时，之前的请求是 Create 操作，那么应用的 catch 到这个异常，应用一个可能的恢复逻辑就是，判断之前请求创建的节点的是否已经存在了，如果存在就不要再创建了，否则就创建。</span><br><span class="line"></span><br><span class="line">再比如，如果应用使用了 exists Watch 去监听一个不存在的节点的创建的事件，那么在 ConnectionLossException 的期间，有可能遇到的情况是，在这个闪断期间，其它的客户端进程可能已经创建了节点，并且又已经删除了，那么对于当前应用来说，就 miss 了一次关心的节点的创建事件，这种 miss 对应用的影响是什么？是可以忍受的还是不可接受？需要应用开发者自己根据业务语义去评估和处理。</span><br><span class="line"></span><br><span class="line">SessionExpiredException 和 SessionExpired 事件</span><br><span class="line"></span><br><span class="line">Session 超时是一个不可恢复的异常，这是指应用 Catch 到这个异常的时候，应用不可能在同一个 Session 中恢复应用状态，必须要重新建立新 Session，老 Session 关联的临时节点也可能已经失效，拥有的锁可能已经失效。...</span><br></pre></td></tr></table></figure>
<p>我们阿里巴巴的小伙伴在自行尝试使用 ZooKeeper 做服务发现的过程中，曾经在我们的内网技术论坛上总结过一篇自己踩坑的经验分享</p>
<img src="/2018/06/13/ali-nonuse-zk/trap.png" title="trap">
<p>在该文中中肯的提到:</p>
<p>… 在编码过程中发现很多可能存在的陷阱，毛估估，第一次使用 zk 来实现集群管理的人应该有 80% 以上会掉坑，有些坑比较隐蔽，在网络问题或者异常的场景时才会出现，可能很长一段时间才会暴露出来 …</p>
<p>这篇文章已经分享到云栖社区, 你可以点击 这里 详细阅读。</p>
<p>#向左走，向右走</p>
<p>阿里巴巴是不是完全没有使用 ZooKeeper？并不是！</p>
<p>熟悉阿里巴巴技术体系的都知道，其实阿里巴巴维护了目前国内乃至世界上最大规模的 ZooKeeper 集群，整体规模有近千台的 ZooKeeper 服务节点。</p>
<p>同时阿里巴巴中间件内部也维护了一个面向大规模生产的、高可用、更易监控和运维的 ZooKeeper 的代码分支 TaoKeeper，如果以我们近 10 年在各个业务线和生产上使用 ZooKeeper 的实践，给 ZooKeeper 用一个短语评价的话，那么我们认为 ZooKeeper 应该是 “The King Of Coordination for Big Data”！</p>
<img src="/2018/06/13/ali-nonuse-zk/coordination.png" title="The King Of Coordination for Big Data">
<p>在粗粒度分布式锁，分布式选主，主备高可用切换等不需要高 TPS 支持的场景下有不可替代的作用，而这些需求往往多集中在大数据、离线任务等相关的业务领域，因为大数据领域，讲究分割数据集，并且大部分时间分任务多进程 / 线程并行处理这些数据集，但是总是有一些点上需要将这些任务和进程统一协调，这时候就是 ZooKeeper 发挥巨大作用的用武之地。</p>
<p>但是在交易场景交易链路上，在主业务数据存取，大规模服务发现、大规模健康监测等方面有天然的短板，应该竭力避免在这些场景下引入 ZooKeeper，在阿里巴巴的生产实践中，应用对 ZooKeeper 申请使用的时候要进行严格的场景、容量、SLA 需求的评估。</p>
<p>所以可以使用 ZooKeeper，但是大数据请向左，而交易则向右，分布式协调向左，服务发现向右。</p>
<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>感谢你耐心的阅读到这里，至此，我相信你已经理解，我们写这篇文章并不是全盘否定 ZooKeeper，而只是根据我们阿里巴巴近 10 年来在大规模服务化上的生产实践，对我们在服务发现和注册中心设计及使用上的经验教训进行一个总结，希望对业界就如何更好的使用 ZooKeeper，如何更好的设计自己的服务注册中心有所启发和帮助。</p>
<p>最后，条条大路通罗马，衷心祝愿你的注册中心直接就诞生在罗马。</p>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p>[1] <a href="https://medium.com/knerd/eureka-why-you-shouldnt-use-zookeeper-for-service-discovery-4932c5c7e764" target="_blank" rel="noopener">https://medium.com/knerd/eureka-why-you-shouldnt-use-zookeeper-for-service-discovery-4932c5c7e764</a><br>[2] <a href="https://yq.aliyun.com/articles/227260" target="_blank" rel="noopener">https://yq.aliyun.com/articles/227260</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.finegames.cn/2018/01/19/dubbo-spi-trace/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王召辉">
      <meta itemprop="description" content="Seven times I have despised my soul">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王召辉">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/19/dubbo-spi-trace/" itemprop="url">
                  基于dubbo SPI实现trace
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-01-19 23:53:32" itemprop="dateCreated datePublished" datetime="2018-01-19T23:53:32+08:00">2018-01-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-09-11 10:26:21" itemprop="dateModified" datetime="2018-09-11T10:26:21+08:00">2018-09-11</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/dubbo/" itemprop="url" rel="index"><span itemprop="name">dubbo</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/dubbo/实例/" itemprop="url" rel="index"><span itemprop="name">实例</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/19/dubbo-spi-trace/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/19/dubbo-spi-trace/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/01/19/dubbo-spi-trace/" class="leancloud_visitors" data-flag-title="基于dubbo SPI实现trace">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>随着公司业务增长，系统间交互变得频繁，由于目前公司架构以及基础设施都比较差bug不断，通常需要多个系统共同排查问题。对于跨系统定位bug问题，由于没有一个统一的traceId，很难将一个业务线的请求跟另一个业务线的请求关联起来。于是花了点时间，写了一套简单的解决方案，目前也在向各业务线进行推广。</p>
<p>因为内部系统使用的Dubbo作为RPC框架，该方案也是针对dubbo。代码地址：<a href="https://github.com/metogefun/shadow" target="_blank" rel="noopener">https://github.com/metogefun/shadow</a></p>
<p>设计之初最优先考虑的就是零侵入。为了使业务线更方便接入，所有一切都为了给业务线节省成本。该方案主要实用了Dubbo的<code>SPI机制</code>扩展了Filter，自定义两个不同的Filter，<code>TraceProviderFilter</code>和<code>TraceConsumerFilter</code>。实现的功能也很简单，从代码就能看出来做了什么。</p>
<p>TraceConsumerFilter，从<code>TraceContext</code>中获取已经放入的TRACE_ID，对使用次数进行+1操作，并将TRACE_ID作为附加参数传递到Dubbo Provider端，并在操作执行完成后进行释放，也就是-1。当为使用次数为0时，清除TraceContext。还有一个关键问题就是TRACE_ID是怎么初始化的呢？首先一个调用开始，肯定有一个主动出发的事件，大多数是用户的操作，也就是从web项目提供的接口开始，这时候需要在web程序中加一个拦截器，初始化TraceContext放入一个UUID生成的TRACE_ID，这个TRACE_ID存在ThreadLocal中方式并发存在的问题。</p>
<p>TraceProviderFilter，在附加参数中获取TRACE_ID，并初始化它自己的TraceContext，如果该dubbo服务需要调用其他dubbo服务，需要将该TraceID传递下去，当然方法执行完成后，TRACE_ID也会进行销毁。</p>
<p>这样整个调用链就可以绑定到同一个TraceId上，解决了我们开始提出的问题。后面也可以针对该TraceID做一些调用时长的监控，不过有很多解决方案，例如CAT、Pinpoint等，不过最简单的方案还是Pinpoint通过JavaAgent，不侵入代码，但是对性能会有影响。目前也在测试环境搭建了pinpoint环境很方便，并且针对于报警的二次开发很简单，也是推荐在没有成熟的调用链监控方案上，pinpoint不失为一种快捷有效的方式。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.finegames.cn/2018/01/10/zk-zab/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王召辉">
      <meta itemprop="description" content="Seven times I have despised my soul">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王召辉">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/10/zk-zab/" itemprop="url">
                  (转载）实例详解ZooKeeper ZAB协议、分布式锁与领导选举
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-01-10 22:44:20" itemprop="dateCreated datePublished" datetime="2018-01-10T22:44:20+08:00">2018-01-10</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-09-10 23:48:27" itemprop="dateModified" datetime="2018-09-10T23:48:27+08:00">2018-09-10</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/zookeeper/" itemprop="url" rel="index"><span itemprop="name">zookeeper</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/10/zk-zab/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/10/zk-zab/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/01/10/zk-zab/" class="leancloud_visitors" data-flag-title="(转载）实例详解ZooKeeper ZAB协议、分布式锁与领导选举">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文转载自<a href="http://www.jasongj.com/" target="_blank" rel="noopener">原地址</a></p>
<img src="/2018/01/10/zk-zab/t1.png" title="title">
<p>本节将介绍ZooKeeper的架构，并结合实例分析原子广播(ZAB)协议的原理，包括但不限于ZooKeeper的读写流程，FastLeaderElection算法的原理，ZAB如何保证Leader Failover过程中的数据一致性。</p>
<h2 id="ZooKeeper是什么"><a href="#ZooKeeper是什么" class="headerlink" title="ZooKeeper是什么"></a>ZooKeeper是什么</h2><p>ZooKeeper是一个分布式协调服务，可用于服务发现、分布式锁、分布式领导选举、配置管理等。</p>
<p>这一切的基础，都是ZooKeeper提供了一个类似于Linux文件系统的树形结构（可认为是轻量级的内存文件系统，但只适合存少量信息，完全不适合存储大量文件或者大文件），同时提供了对于每个节点的监控与通知机制。</p>
<p>既然是一个文件系统，就不得不提ZooKeeper是如何保证数据的一致性的。本节将将介绍ZooKeeper如何保证数据一致性，如何进行领导选举，以及数据监控/通知机制的语义保证。</p>
<h2 id="ZooKeeper服务器角色"><a href="#ZooKeeper服务器角色" class="headerlink" title="ZooKeeper服务器角色"></a>ZooKeeper服务器角色</h2><p>ZooKeeper集群是一个基于主从复制的高可用集群，每个服务器承担如下三种角色中的一种：</p>
<ul>
<li>Leader 一个ZooKeeper集群同一时间只会有一个实际工作的Leader，它会发起并维护与各Follwer及Observer间的心跳。所有的写操作必须要通过Leader完成再由Leader将写操作广播给其它服务器。</li>
<li>Follower 一个ZooKeeper集群可能同时存在多个Follower，它会响应Leader的心跳。Follower可直接处理并返回客户端的读请求，同时会将写请求转发给Leader处理，并且负责在Leader处理写请求时对请求进行投票。</li>
<li>Observer 角色与Follower类似，但是无投票权。</li>
</ul>
<img src="/2018/01/10/zk-zab/1.jpg" title="zookeeper ensemble">
<h2 id="原子广播（ZAB）"><a href="#原子广播（ZAB）" class="headerlink" title="原子广播（ZAB）"></a>原子广播（ZAB）</h2><p>为了保证写操作的一致性与可用性，ZooKeeper专门设计了一种名为原子广播（ZAB）的支持崩溃恢复的一致性协议。基于该协议，ZooKeeper实现了一种主从模式的系统架构来保持集群中各个副本之间的数据一致性。</p>
<p>根据ZAB协议，所有的写操作都必须通过Leader完成，Leader写入本地日志后再复制到所有的Follower节点。</p>
<p>一旦Leader节点无法工作，ZAB协议能够自动从Follower节点中重新选出一个合适的替代者，即新的Leader，该过程即为领导选举。该领导选举过程，是ZAB协议中最为重要和复杂的过程。</p>
<h3 id="1、写Leader"><a href="#1、写Leader" class="headerlink" title="1、写Leader"></a>1、写Leader</h3><p>通过Leader进行写操作流程如下图所示：</p>
<img src="/2018/01/10/zk-zab/2.jpg" title="zookeeper ensemble">
<p>由上图可见，通过Leader进行写操作，主要分为五步：</p>
<ul>
<li>客户端向Leader发起写请求</li>
<li>Leader将写请求以Proposal的形式发给所有Follower并等待ACK</li>
<li>Follower收到Leader的Proposal后返回ACK</li>
<li>Leader得到过半数的ACK（Leader对自己默认有一个ACK）后向所有的Follower和Observer发送Commmit</li>
<li>Leader将处理结果返回给客户端</li>
</ul>
<p><code>这里要注意</code>：</p>
<ul>
<li>Leader并不需要得到Observer的ACK，即Observer无投票权</li>
<li>Leader不需要得到所有Follower的ACK，只要收到过半的ACK即可，同时Leader本身对自己有一个ACK。上图中有4个Follower，只需其中两个返回ACK即可，因为(2+1) / (4+1) &gt; 1/2</li>
<li>Observer虽然无投票权，但仍须同步Leader的数据从而在处理读请求时可以返回尽可能新的数据</li>
</ul>
<h3 id="2、写Follower-Observer"><a href="#2、写Follower-Observer" class="headerlink" title="2、写Follower/Observer"></a>2、写Follower/Observer</h3><p>通过Follower/Observer进行写操作流程如下图所示：</p>
<img src="/2018/01/10/zk-zab/3.jpg" title="zookeeper ensemble">
<p>从上图可见：</p>
<ul>
<li>Follower/Observer均可接受写请求，但不能直接处理，而需要将写请求转发给Leader处理</li>
<li>除了多了一步请求转发，其它流程与直接写Leader无任何区别</li>
</ul>
<h3 id="3、读操作"><a href="#3、读操作" class="headerlink" title="3、读操作"></a>3、读操作</h3><p>Leader/Follower/Observer都可直接处理读请求，从本地内存中读取数据并返回给客户端即可。</p>
<img src="/2018/01/10/zk-zab/4.jpg" title="zookeeper ensemble">
<p>由于处理读请求不需要服务器之间的交互，Follower/Observer越多，整体可处理的读请求量越大，也即读性能越好。</p>
<h2 id="支持的领导选举算法"><a href="#支持的领导选举算法" class="headerlink" title="支持的领导选举算法"></a>支持的领导选举算法</h2><p>可通过electionAlg配置项设置ZooKeeper用于领导选举的算法。到3.4.10版本为止，可选项有：</p>
<ul>
<li>0 基于UDP的LeaderElection</li>
<li>1 基于UDP的FastLeaderElection</li>
<li>2 基于UDP和认证的FastLeaderElection</li>
<li>3 基于TCP的FastLeaderElection</li>
</ul>
<p>在3.4.10版本中，默认值为3，也即基于TCP的FastLeaderElection。另外三种算法已经被弃用，并且有计划在之后的版本中将它们彻底删除而不再支持。</p>
<h2 id="FastLeaderElection原理"><a href="#FastLeaderElection原理" class="headerlink" title="FastLeaderElection原理"></a>FastLeaderElection原理</h2><h3 id="1、myid"><a href="#1、myid" class="headerlink" title="1、myid"></a>1、myid</h3><p>每个ZooKeeper服务器，都需要在数据文件夹下创建一个名为myid的文件，该文件包含整个ZooKeeper集群唯一的ID（整数）。例如，某ZooKeeper集群包含三台服务器，hostname分别为zoo1、zoo2和zoo3，其myid分别为1、2和3，则在配置文件中其ID与hostname必须一一对应，如下所示。在该配置文件中，server.后面的数据即为myid</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server.1=zoo1:2888:3888</span><br><span class="line">server.2=zoo2:2888:3888</span><br><span class="line">server.3=zoo3:2888:3888</span><br></pre></td></tr></table></figure>
<h3 id="2、zxid"><a href="#2、zxid" class="headerlink" title="2、zxid"></a>2、zxid</h3><p>类似于RDBMS中的事务ID，用于标识一次更新操作的Proposal ID。为了保证顺序性，该zkid必须单调递增。因此ZooKeeper使用一个64位的数来表示，高32位是Leader的epoch，从1开始，每次选出新的Leader，epoch加一。低32位为该epoch内的序号，每次epoch变化，都将低32位的序号重置。这样保证了zkid的全局递增性。</p>
<h3 id="3、服务器状态"><a href="#3、服务器状态" class="headerlink" title="3、服务器状态"></a>3、服务器状态</h3><ul>
<li>LOOKING 不确定Leader状态。该状态下的服务器认为当前集群中没有Leader，会发起Leader选举。</li>
<li>FOLLOWING 跟随者状态。表明当前服务器角色是Follower，并且它知道Leader是谁。</li>
<li>LEADING 领导者状态。表明当前服务器角色是Leader，它会维护与Follower间的心跳。</li>
<li>OBSERVING 观察者状态。表明当前服务器角色是Observer，与Folower唯一的不同在于不参与选举，也不参与集群写操作时的投票。</li>
</ul>
<h3 id="4、选票数据结构"><a href="#4、选票数据结构" class="headerlink" title="4、选票数据结构"></a>4、选票数据结构</h3><p>每个服务器在进行领导选举时，会发送如下关键信息：</p>
<ul>
<li>logicClock 每个服务器会维护一个自增的整数，名为logicClock，它表示这是该服务器发起的第多少轮投票</li>
<li>state 当前服务器的状态</li>
<li>self_id 当前服务器的myid</li>
<li>self_zxid 当前服务器上所保存的数据的最大zxid</li>
<li>vote_id 被推举的服务器的myid</li>
<li>vote_zxid 被推举的服务器上所保存的数据的最大zxid</li>
</ul>
<h3 id="5、投票流程"><a href="#5、投票流程" class="headerlink" title="5、投票流程"></a>5、投票流程</h3><h4 id="自增选举轮次"><a href="#自增选举轮次" class="headerlink" title="自增选举轮次"></a>自增选举轮次</h4><p>ZooKeeper规定所有有效的投票都必须在同一轮次中。每个服务器在开始新一轮投票时，会先对自己维护的logicClock进行自增操作。</p>
<h4 id="初始化选票"><a href="#初始化选票" class="headerlink" title="初始化选票"></a>初始化选票</h4><p>每个服务器在广播自己的选票前，会将自己的投票箱清空。该投票箱记录了所收到的选票。例：服务器2投票给服务器3，服务器3投票给服务器1，则服务器1的投票箱为(2, 3), (3, 1), (1, 1)。票箱中只会记录每一投票者的最后一票，如投票者更新自己的选票，则其它服务器收到该新选票后会在自己票箱中更新该服务器的选票。</p>
<h4 id="发送初始化选票"><a href="#发送初始化选票" class="headerlink" title="发送初始化选票"></a>发送初始化选票</h4><p>每个服务器最开始都是通过广播把票投给自己。</p>
<h4 id="接收外部投票"><a href="#接收外部投票" class="headerlink" title="接收外部投票"></a>接收外部投票</h4><p>服务器会尝试从其它服务器获取投票，并记入自己的投票箱内。如果无法获取任何外部投票，则会确认自己是否与集群中其它服务器保持着有效连接。如果是，则再次发送自己的投票；如果否，则马上与之建立连接。</p>
<h4 id="判断选举轮次"><a href="#判断选举轮次" class="headerlink" title="判断选举轮次"></a>判断选举轮次</h4><p>收到外部投票后，首先会根据投票信息中所包含的logicClock来进行不同处理：</p>
<ul>
<li>外部投票的logicClock大于自己的logicClock。说明该服务器的选举轮次落后于其它服务器的选举轮次，立即清空自己的投票箱并将自己的logicClock更新为收到的logicClock，然后再对比自己之前的投票与收到的投票以确定是否需要变更自己的投票，最终再次将自己的投票广播出去。</li>
<li>外部投票的logicClock小于自己的logicClock。当前服务器直接忽略该投票，继续处理下一个投票。</li>
<li>外部投票的logickClock与自己的相等。当时进行选票PK。</li>
</ul>
<h4 id="选票PK"><a href="#选票PK" class="headerlink" title="选票PK"></a>选票PK</h4><p>选票PK是基于(self_id, self_zxid)与(vote_id, vote_zxid)的对比：</p>
<ul>
<li>外部投票的logicClock大于自己的logicClock，则将自己的logicClock及自己的选票的logicClock变更为收到的logicClock</li>
<li>若logicClock一致，则对比二者的vote_zxid，若外部投票的vote_zxid比较大，则将自己的票中的vote_zxid与vote_myid更新为收到的票中的vote_zxid与vote_myid并广播出去，另外将收到的票及自己更新后的票放入自己的票箱。如果票箱内已存在(self_myid, self_zxid)相同的选票，则直接覆盖</li>
<li>若二者vote_zxid一致，则比较二者的vote_myid，若外部投票的vote_myid比较大，则将自己的票中的vote_myid更新为收到的票中的vote_myid并广播出去，另外将收到的票及自己更新后的票放入自己的票箱</li>
</ul>
<h4 id="统计选票"><a href="#统计选票" class="headerlink" title="统计选票"></a>统计选票</h4><p>如果已经确定有过半服务器认可了自己的投票（可能是更新后的投票），则终止投票。否则继续接收其它服务器的投票。</p>
<h4 id="更新服务器状态"><a href="#更新服务器状态" class="headerlink" title="更新服务器状态"></a>更新服务器状态</h4><p>投票终止后，服务器开始更新自身状态。若过半的票投给了自己，则将自己的服务器状态更新为LEADING，否则将自己的状态更新为FOLLOWING。</p>
<h2 id="集群启动领导选举"><a href="#集群启动领导选举" class="headerlink" title="集群启动领导选举"></a>集群启动领导选举</h2><h3 id="1、初始投票给自己"><a href="#1、初始投票给自己" class="headerlink" title="1、初始投票给自己"></a>1、初始投票给自己</h3><p>集群刚启动时，所有服务器的logicClock都为1，zxid都为0。各服务器初始化后，都投票给自己，并将自己的一票存入自己的票箱，如下图所示。</p>
<img src="/2018/01/10/zk-zab/5.jpg" title="zookeeper ensemble">
<p>在上图中，(1, 1, 0)第一位数代表投出该选票的服务器的logicClock，第二位数代表被推荐的服务器的myid，第三位代表被推荐的服务器的最大的zxid。由于该步骤中所有选票都投给自己，所以第二位的myid即是自己的myid，第三位的zxid即是自己的zxid。</p>
<p>此时各自的票箱中只有自己投给自己的一票。</p>
<h3 id="2、更新选票"><a href="#2、更新选票" class="headerlink" title="2、更新选票"></a>2、更新选票</h3><p>服务器收到外部投票后，进行选票PK，相应更新自己的选票并广播出去，并将合适的选票存入自己的票箱，如下图所示。</p>
<img src="/2018/01/10/zk-zab/6.jpg" title="zookeeper ensemble">
<p>服务器1收到服务器2的选票（1, 2, 0）和服务器3的选票（1, 3, 0）后，由于所有的logicClock都相等，所有的zxid都相等，因此根据myid判断应该将自己的选票按照服务器3的选票更新为（1, 3, 0），并将自己的票箱全部清空，再将服务器3的选票与自己的选票存入自己的票箱，接着将自己更新后的选票广播出去。此时服务器1票箱内的选票为(1, 3)，(3, 3)。</p>
<p>同理，服务器2收到服务器3的选票后也将自己的选票更新为（1, 3, 0）并存入票箱然后广播。此时服务器2票箱内的选票为(2, 3)，(3, ,3)。</p>
<p>服务器3根据上述规则，无须更新选票，自身的票箱内选票仍为（3, 3）。</p>
<p>服务器1与服务器2更新后的选票广播出去后，由于三个服务器最新选票都相同，最后三者的票箱内都包含三张投给服务器3的选票。</p>
<h3 id="3、根据选票确定角色"><a href="#3、根据选票确定角色" class="headerlink" title="3、根据选票确定角色"></a>3、根据选票确定角色</h3><p>根据上述选票，三个服务器一致认为此时服务器3应该是Leader。因此服务器1和2都进入FOLLOWING状态，而服务器3进入LEADING状态。之后Leader发起并维护与Follower间的心跳。</p>
<img src="/2018/01/10/zk-zab/7.jpg" title="zookeeper ensemble">
<h2 id="Follower重启选举"><a href="#Follower重启选举" class="headerlink" title="Follower重启选举"></a>Follower重启选举</h2><h3 id="1、Follower重启投票给自己"><a href="#1、Follower重启投票给自己" class="headerlink" title="1、Follower重启投票给自己"></a>1、Follower重启投票给自己</h3><p>Follower重启，或者发生网络分区后找不到Leader，会进入LOOKING状态并发起新的一轮投票。</p>
<img src="/2018/01/10/zk-zab/8.jpg" title="zookeeper ensemble">
<h3 id="2、发现已有Leader后成为Follower"><a href="#2、发现已有Leader后成为Follower" class="headerlink" title="2、发现已有Leader后成为Follower"></a>2、发现已有Leader后成为Follower</h3><p>服务器3收到服务器1的投票后，将自己的状态LEADING以及选票返回给服务器1。服务器2收到服务器1的投票后，将自己的状态FOLLOWING及选票返回给服务器1。此时服务器1知道服务器3是Leader，并且通过服务器2与服务器3的选票可以确定服务器3确实得到了超过半数的选票。因此服务器1进入FOLLOWING状态。</p>
<img src="/2018/01/10/zk-zab/9.jpg" title="zookeeper ensemble">
<h2 id="Leader重启选举"><a href="#Leader重启选举" class="headerlink" title="Leader重启选举"></a>Leader重启选举</h2><h3 id="1、Follower发起新投票"><a href="#1、Follower发起新投票" class="headerlink" title="1、Follower发起新投票"></a>1、Follower发起新投票</h3><img src="/2018/01/10/zk-zab/10.jpg" title="zookeeper ensemble">
<p>Leader（服务器3）宕机后，Follower（服务器1和2）发现Leader不工作了，因此进入LOOKING状态并发起新的一轮投票，并且都将票投给自己。</p>
<h3 id="2、广播更新选票"><a href="#2、广播更新选票" class="headerlink" title="2、广播更新选票"></a>2、广播更新选票</h3><p>服务器1和2根据外部投票确定是否要更新自身的选票。这里有两种情况：</p>
<ul>
<li>服务器1和2的zxid相同。例如在服务器3宕机前服务器1与2完全与之同步。此时选票的更新主要取决于myid的大小</li>
<li>服务器1和2的zxid不同。在旧Leader宕机之前，其所主导的写操作，只需过半服务器确认即可，而不需所有服务器确认。换句话说，服务器1和2可能一个与旧Leader同步（即zxid与之相同）另一个不同步（即zxid比之小）。此时选票的更新主要取决于谁的zxid较大</li>
</ul>
<p>在上图中，服务器1的zxid为11，而服务器2的zxid为10，因此服务器2将自身选票更新为（3, 1, 11），如下图所示。</p>
<img src="/2018/01/10/zk-zab/11.jpg" title="zookeeper ensemble">
<h3 id="3、选出新Leader"><a href="#3、选出新Leader" class="headerlink" title="3、选出新Leader"></a>3、选出新Leader</h3><p>经过上一步选票更新后，服务器1与服务器2均将选票投给服务器1，因此服务器2成为Follower，而服务器1成为新的Leader并维护与服务器2的心跳。</p>
<img src="/2018/01/10/zk-zab/12.jpg" title="zookeeper ensemble">
<h3 id="4、旧Leader恢复后发起选举"><a href="#4、旧Leader恢复后发起选举" class="headerlink" title="4、旧Leader恢复后发起选举"></a>4、旧Leader恢复后发起选举</h3><p>旧的Leader恢复后，进入LOOKING状态并发起新一轮领导选举，并将选票投给自己。此时服务器1会将自己的LEADING状态及选票（3, 1, 11）返回给服务器3，而服务器2将自己的FOLLOWING状态及选票（3, 1, 11）返回给服务器3。如下图所示。</p>
<img src="/2018/01/10/zk-zab/13.jpg" title="zookeeper ensemble"> 
<h3 id="5、旧Leader成为Follower"><a href="#5、旧Leader成为Follower" class="headerlink" title="5、旧Leader成为Follower"></a>5、旧Leader成为Follower</h3><p>服务器3了解到Leader为服务器1，且根据选票了解到服务器1确实得到过半服务器的选票，因此自己进入FOLLOWING状态。</p>
<img src="/2018/01/10/zk-zab/14.jpg" title="zookeeper ensemble">
<h2 id="Commit过的数据不丢失"><a href="#Commit过的数据不丢失" class="headerlink" title="Commit过的数据不丢失"></a>Commit过的数据不丢失</h2><h3 id="1、Failover前状态"><a href="#1、Failover前状态" class="headerlink" title="1、Failover前状态"></a>1、Failover前状态</h3><p>为更好演示Leader Failover过程，本例中共使用5个ZooKeeper服务器。A作为Leader，共收到P1、P2、P3三条消息，并且Commit了1和2，且总体顺序为P1、P2、C1、P3、C2。根据顺序性原则，其它Follower收到的消息的顺序肯定与之相同。其中B与A完全同步，C收到P1、P2、C1，D收到P1、P2，E收到P1，如下图所示。</p>
<img src="/2018/01/10/zk-zab/15.jpg" title="zookeeper ensemble"> 
<p>这里要注意：</p>
<ul>
<li>由于A没有C3，意味着收到P3的服务器的总个数不会超过一半，也即包含A在内最多只有两台服务器收到P3。在这里A和B收到P3，其它服务器均未收到P3</li>
<li>由于A已写入C1、C2，说明它已经Commit了P1、P2，因此整个集群有超过一半的服务器，即最少三个服务器收到P1、P2。在这里所有服务器都收到了P1，除E外其它服务器也都收到了P2</li>
</ul>
<h3 id="2、选出新Leader"><a href="#2、选出新Leader" class="headerlink" title="2、选出新Leader"></a>2、选出新Leader</h3><p>旧Leader也即A宕机后，其它服务器根据上述FastLeaderElection算法选出B作为新的Leader。C、D和E成为Follower且以B为Leader后，会主动将自己最大的zxid发送给B，B会将Follower的zxid与自身zxid间的所有被Commit过的消息同步给Follower，如下图所示。</p>
<img src="/2018/01/10/zk-zab/16.jpg" title="zookeeper ensemble">
<p>在上图中：</p>
<ul>
<li>P1和P2都被A Commit，因此B会通过同步保证P1、P2、C1与C2都存在于C、D和E中</li>
<li>P3由于未被A Commit，同时幸存的所有服务器中P3未存在于大多数据服务器中，因此它不会被同步到其它Follower</li>
</ul>
<h3 id="3、通知Follower可对外服务"><a href="#3、通知Follower可对外服务" class="headerlink" title="3、通知Follower可对外服务"></a>3、通知Follower可对外服务</h3><p>同步完数据后，B会向D、C和E发送NEWLEADER命令并等待大多数服务器的ACK（下图中D和E已返回ACK，加上B自身，已经占集群的大多数），然后向所有服务器广播UPTODATE命令。收到该命令后的服务器即可对外提供服务。</p>
<img src="/2018/01/10/zk-zab/17.jpg" title="zookeeper ensemble">
<h2 id="未Commit过的消息对客户端不可见"><a href="#未Commit过的消息对客户端不可见" class="headerlink" title="未Commit过的消息对客户端不可见"></a>未Commit过的消息对客户端不可见</h2><p>在上例中，P3未被A Commit过，同时因为没有过半的服务器收到P3，因此B也未Commit P3（如果有过半服务器收到P3，即使A未Commit P3，B会主动Commit P3，即C3），所以它不会将P3广播出去。</p>
<p>具体做法是，B在成为Leader后，先判断自身未Commit的消息（本例中即P3）是否存在于大多数服务器中从而决定是否要将其Commit。然后B可得出自身所包含的被Commit过的消息中的最小zxid（记为min_zxid）与最大zxid（记为max_zxid）。C、D和E向B发送自身Commit过的最大消息zxid（记为max_zxid）以及未被Commit过的所有消息（记为zxid_set）。B根据这些信息作出如下操作：</p>
<ul>
<li>如果Follower的max_zxid与Leader的max_zxid相等，说明该Follower与Leader完全同步，无须同步任何数据</li>
<li>如果Follower的max_zxid在Leader的(min_zxid，max_zxid)范围内，Leader会通过TRUNC命令通知Follower将其zxid_set中大于Follower的max_zxid（如果有）的所有消息全部删除</li>
</ul>
<p>上述操作保证了未被Commit过的消息不会被Commit从而对外不可见。</p>
<p>上述例子中Follower上并不存在未被Commit的消息。但可考虑这种情况，如果将上述例子中的服务器数量从五增加到七，服务器F包含P1、P2、C1、P3，服务器G包含P1、P2。此时服务器F、A和B都包含P3，但是因为票数未过半，因此B作为Leader不会Commit P3，而会通过TRUNC命令通知F删除P3。如下图所示。</p>
<img src="/2018/01/10/zk-zab/18.jpg" title="zookeeper ensemble">
<p>本节总结</p>
<ul>
<li>由于使用主从复制模式，所有的写操作都要由Leader主导完成，而读操作可通过任意节点完成，因此ZooKeeper读性能远好于写性能，更适合读多写少的场景</li>
<li>虽然使用主从复制模式，同一时间只有一个Leader，但是Failover机制保证了集群不存在单点失败（SPOF）的问题</li>
<li>ZAB协议保证了Failover过程中的数据一致性</li>
<li>服务器收到数据后先写本地文件再进行处理，保证了数据的持久性</li>
</ul>
<img src="/2018/01/10/zk-zab/t2.png" title="title">
<p>本节将结合实例演示了使用ZooKeeper实现分布式锁与领导选举的原理与具体实现方法。</p>
<h2 id="ZooKeeper节点类型"><a href="#ZooKeeper节点类型" class="headerlink" title="ZooKeeper节点类型"></a>ZooKeeper节点类型</h2><p>ZooKeeper 提供了一个类似于 Linux 文件系统的树形结构。该树形结构中每个节点被称为 znode ，可按如下两个维度分类：</p>
<h3 id="1、Persist-vs-Ephemeral"><a href="#1、Persist-vs-Ephemeral" class="headerlink" title="1、Persist vs. Ephemeral"></a>1、Persist vs. Ephemeral</h3><ul>
<li>Persist节点，一旦被创建，便不会意外丢失，即使服务器全部重启也依然存在。每个 Persist 节点即可包含数据，也可包含子节点</li>
<li>Ephemeral节点，在创建它的客户端与服务器间的 Session 结束时自动被删除。服务器重启会导致 Session 结束，因此 Ephemeral 类型的 znode 此时也会自动删除</li>
</ul>
<h3 id="2、Sequence-vs-Non-sequence"><a href="#2、Sequence-vs-Non-sequence" class="headerlink" title="2、Sequence vs. Non-sequence"></a>2、Sequence vs. Non-sequence</h3><p>Non-sequence节点，多个客户端同时创建同一 Non-sequence 节点时，只有一个可创建成功，其它匀失败。并且创建出的节点名称与创建时指定的节点名完全一样</p>
<p>Sequence节点，创建出的节点名在指定的名称之后带有10位10进制数的序号。多个客户端创建同一名称的节点时，都能创建成功，只是序号不同</p>
<h2 id="ZooKeeper语义保证"><a href="#ZooKeeper语义保证" class="headerlink" title="ZooKeeper语义保证"></a>ZooKeeper语义保证</h2><p>ZooKeeper简单高效，同时提供如下语义保证，从而使得我们可以利用这些特性提供复杂的服务。</p>
<ul>
<li>顺序性：客户端发起的更新会按发送顺序被应用到 ZooKeeper 上</li>
<li>原子性：更新操作要么成功要么失败，不会出现中间状态</li>
<li>单一系统镜像：一个客户端无论连接到哪一个服务器都能看到完全一样的系统镜像（即完全一样的树形结构）。注：根据上文《ZooKeeper架构及FastLeaderElection机制》介绍的 ZAB 协议，写操作并不保证更新被所有的 Follower 立即确认，因此通过部分 Follower 读取数据并不能保证读到最新的数据，而部分 Follwer 及 Leader 可读到最新数据。如果一定要保证单一系统镜像，可在读操作前使用 sync 方法。</li>
<li>可靠性：一个更新操作一旦被接受即不会意外丢失，除非被其它更新操作覆盖</li>
<li>最终一致性：写操作最终（而非立即）会对客户端可见</li>
</ul>
<h2 id="ZooKeeper-Watch机制"><a href="#ZooKeeper-Watch机制" class="headerlink" title="ZooKeeper Watch机制"></a>ZooKeeper Watch机制</h2><p>所有对 ZooKeeper 的读操作，都可附带一个 Watch 。一旦相应的数据有变化，该 Watch 即被触发。</p>
<p>Watch 有如下特点：</p>
<ul>
<li>主动推送：Watch被触发时，由 ZooKeeper 服务器主动将更新推送给客户端，而不需要客户端轮询。</li>
<li>一次性：数据变化时，Watch 只会被触发一次。如果客户端想得到后续更新的通知，必须要在 Watch 被触发后重新注册一个 Watch。</li>
<li>可见性：如果一个客户端在读请求中附带 Watch，Watch 被触发的同时再次读取数据，客户端在得到 Watch 消息之前肯定不可能看到更新后的数据。换句话说，更新通知先于更新结果。</li>
<li>顺序性：如果多个更新触发了多个 Watch ，那 Watch 被触发的顺序与更新顺序一致。</li>
</ul>
<h2 id="分布式锁与领导选举关键点"><a href="#分布式锁与领导选举关键点" class="headerlink" title="分布式锁与领导选举关键点"></a>分布式锁与领导选举关键点</h2><h3 id="1、最多一个获取锁-成为Leader"><a href="#1、最多一个获取锁-成为Leader" class="headerlink" title="1、最多一个获取锁 / 成为Leader"></a>1、最多一个获取锁 / 成为Leader</h3><p>对于分布式锁（这里特指排它锁）而言，任意时刻，最多只有一个进程（对于单进程内的锁而言是单线程）可以获得锁。</p>
<p>对于领导选举而言，任意时间，最多只有一个成功当选为Leader。否则即出现脑裂（Split brain）</p>
<h3 id="2、锁重入-确认自己是Leader"><a href="#2、锁重入-确认自己是Leader" class="headerlink" title="2、锁重入 / 确认自己是Leader"></a>2、锁重入 / 确认自己是Leader</h3><p>对于分布式锁，需要保证获得锁的进程在释放锁之前可再次获得锁，即锁的可重入性。</p>
<p>对于领导选举，Leader需要能够确认自己已经获得领导权，即确认自己是Leader。</p>
<h3 id="3、释放锁-放弃领导权"><a href="#3、释放锁-放弃领导权" class="headerlink" title="3、释放锁 / 放弃领导权"></a>3、释放锁 / 放弃领导权</h3><p>锁的获得者应该能够正确释放已经获得的锁，并且当获得锁的进程宕机时，锁应该自动释放，从而使得其它竞争方可以获得该锁，从而避免出现死锁的状态。</p>
<p>领导应该可以主动放弃领导权，并且当领导所在进程宕机时，领导权应该自动释放，从而使得其它参与者可重新竞争领导而避免进入无主状态。</p>
<h3 id="4、感知锁释放-领导权的放弃"><a href="#4、感知锁释放-领导权的放弃" class="headerlink" title="4、感知锁释放 / 领导权的放弃"></a>4、感知锁释放 / 领导权的放弃</h3><p>当获得锁的一方释放锁时，其它对于锁的竞争方需要能够感知到锁的释放，并再次尝试获取锁。</p>
<p>原来的Leader放弃领导权时，其它参与方应该能够感知该事件，并重新发起选举流程。</p>
<h2 id="非公平领导选举"><a href="#非公平领导选举" class="headerlink" title="非公平领导选举"></a>非公平领导选举</h2><p>从上面几个方面可见，分布式锁与领导选举的技术要点非常相似，实际上其实现机制也相近。这里以领导选举为例来说明二者的实现原理，分布式锁的实现原理也几乎一致。 </p>
<h3 id="1、选主过程"><a href="#1、选主过程" class="headerlink" title="1、选主过程"></a>1、选主过程</h3><p>假设有三个ZooKeeper的客户端，如下图所示，同时竞争Leader。这三个客户端同时向ZooKeeper集群注册Ephemeral且Non-sequence类型的节点，路径都为 /zkroot/leader（工程实践中，路径名可自定义）。</p>
<img src="/2018/01/10/zk-zab/19.jpg" title="zookeeper ensemble">
<p>如上图所示，由于是Non-sequence节点，这三个客户端只会有一个创建成功，其它节点均创建失败。此时，创建成功的客户端（即上图中的Client 1）即成功竞选为 Leader 。其它客户端（即上图中的Client 2和Client 3）此时匀为 Follower。</p>
<h3 id="2、放弃领导权"><a href="#2、放弃领导权" class="headerlink" title="2、放弃领导权"></a>2、放弃领导权</h3><p>如果 Leader 打算主动放弃领导权，直接删除 /zkroot/leader 节点即可。</p>
<p>如果 Leader 进程意外宕机，其与 ZooKeeper 间的 Session 也结束，该节点由于是Ephemeral类型的节点，因此也会自动被删除。</p>
<p>此时 /zkroot/leader 节点不复存在，对于其它参与竞选的客户端而言，之前的 Leader 已经放弃了领导权。</p>
<h3 id="3、感知领导权的放弃"><a href="#3、感知领导权的放弃" class="headerlink" title="3、感知领导权的放弃"></a>3、感知领导权的放弃</h3><p>由上图可见，创建节点失败的节点，除了成为 Follower 以外，还会向 /zkroot/leader 注册一个 Watch ，一旦 Leader 放弃领导权，也即该节点被删除，所有的 Follower 会收到通知。</p>
<h3 id="4、重新选举"><a href="#4、重新选举" class="headerlink" title="4、重新选举"></a>4、重新选举</h3><p>感知到旧 Leader 放弃领导权后，所有的 Follower 可以再次发起新一轮的领导选举，如下图所示。</p>
<img src="/2018/01/10/zk-zab/20.jpg" title="zookeeper ensemble">
<p>从上图中可见：</p>
<ul>
<li>新一轮的领导选举方法与最初的领导选举方法完全一样，都是发起节点创建请求，创建成功即为 Leader，否则为 Follower ，且 Follower 会 Watch 该节点</li>
<li>新一轮的选举结果，无法预测，与它们在第一轮选举中的顺序无关。这也是该方案被称为非公平模式的原因</li>
</ul>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><ul>
<li>非公平模式实现简单，每一轮选举方法都完全一样</li>
<li>竞争参与方不多的情况下，效率高。每个 Follower 通过 Watch 感知到节点被删除的时间不完全一样，只要有一个 Follower 得到通知即发起竞选，即可保证当时有新的 Leader 被选出</li>
<li>给ZooKeeper 集群造成的负载大，因此扩展性差。如果有上万个客户端都参与竞选，意味着同时会有上万个写请求发送给 Zookeper。如《ZooKeeper架构》一文所述，ZooKeeper 存在单点写的问题，写性能不高。同时一旦 Leader 放弃领导权，ZooKeeper 需要同时通知上万个 Follower，负载较大。</li>
</ul>
<h2 id="公平领导选举"><a href="#公平领导选举" class="headerlink" title="公平领导选举"></a>公平领导选举</h2><h2 id="1、选主过程-1"><a href="#1、选主过程-1" class="headerlink" title="1、选主过程"></a>1、选主过程</h2><p>如下图所示，公平领导选举中，各客户端均创建 /zkroot/leader 节点，且其类型为Ephemeral与Sequence。</p>
<img src="/2018/01/10/zk-zab/21.jpg" title="zookeeper ensemble">
<p>由于是Sequence类型节点，故上图中三个客户端均创建成功，只是序号不一样。此时，每个客户端都会判断自己创建成功的节点的序号是不是当前最小的。如果是，则该客户端为 Leader，否则即为 Follower。</p>
<p>在上图中，Client 1创建的节点序号为 1 ，Client 2创建的节点序号为 2，Client 3创建的节点序号为3。由于最小序号为 1 ，且该节点由Client 1创建，故Client 1为 Leader 。</p>
<h3 id="2、放弃领导权-1"><a href="#2、放弃领导权-1" class="headerlink" title="2、放弃领导权"></a>2、放弃领导权</h3><p>Leader 如果主动放弃领导权，直接删除其创建的节点即可。</p>
<p>如果 Leader 所在进程意外宕机，其与 ZooKeeper 间的 Session 结束，由于其创建的节点为Ephemeral类型，故该节点自动被删除。</p>
<h3 id="3、感知领导权的放弃-1"><a href="#3、感知领导权的放弃-1" class="headerlink" title="3、感知领导权的放弃"></a>3、感知领导权的放弃</h3><p>与非公平模式不同，每个 Follower 并非都 Watch 由 Leader 创建出来的节点，而是 Watch 序号刚好比自己序号小的节点。</p>
<p>在上图中，总共有 1、2、3 共三个节点，因此Client 2 Watch /zkroot/leader1，Client 3 Watch /zkroot/leader2。（注：序号应该是10位数字，而非一位数字，这里为了方便，以一位数字代替）</p>
<p>一旦 Leader 宕机，/zkroot/leader1 被删除，Client 2可得到通知。此时Client 3由于 Watch 的是 /zkroot/leader2 ，故不会得到通知。</p>
<h2 id="重新选举"><a href="#重新选举" class="headerlink" title="重新选举"></a>重新选举</h2><p>重新选举Client 2得到 /zkroot/leader1 被删除的通知后，不会立即成为新的 Leader 。而是先判断自己的序号 2 是不是当前最小的序号。在该场景下，其序号确为最小。因此Client 2成为新的 Leader 。</p>
<img src="/2018/01/10/zk-zab/22.jpg" title="zookeeper ensemble"> 
<p>这里要注意，如果在Client 1放弃领导权之前，Client 2就宕机了，Client 3会收到通知。此时Client 3不会立即成为Leader，而是要先判断自己的序号 3 是否为当前最小序号。很显然，由于Client 1创建的 /zkroot/leader1 还在，因此Client 3不会成为新的 Leader ，并向Client 2序号 2 前面的序号，也即 1 创建 Watch。该过程如下图所示。</p>
<img src="/2018/01/10/zk-zab/23.jpg" title="zookeeper ensemble">
<h2 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h2><ul>
<li>实现相对复杂；</li>
<li>扩展性好，每个客户端都只 Watch 一个节点且每次节点被删除只须通知一个客户端；</li>
<li>旧 Leader 放弃领导权时，其它客户端根据竞选的先后顺序（也即节点序号）成为新 Leader，这也是公平模式的由来；</li>
<li>延迟相对非公平模式要高，因为它必须等待特定节点得到通知才能选出新的 Leader。</li>
</ul>
<h2 id="本节总结"><a href="#本节总结" class="headerlink" title="本节总结"></a>本节总结</h2><p>基于 ZooKeeper 的领导选举或者分布式锁的实现均基于 ZooKeeper 节点的特性及通知机制。充分利用这些特性，还可以开发出适用于其它场景的分布式应用。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.finegames.cn/2017/12/20/search-system/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王召辉">
      <meta itemprop="description" content="Seven times I have despised my soul">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王召辉">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/20/search-system/" itemprop="url">
                  搜索系统实现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-12-20 21:58:45" itemprop="dateCreated datePublished" datetime="2017-12-20T21:58:45+08:00">2017-12-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-09-11 10:57:39" itemprop="dateModified" datetime="2018-09-11T10:57:39+08:00">2018-09-11</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/实例/" itemprop="url" rel="index"><span itemprop="name">实例</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/12/20/search-system/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/12/20/search-system/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/12/20/search-system/" class="leancloud_visitors" data-flag-title="搜索系统实现">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="业务场景"><a href="#业务场景" class="headerlink" title="业务场景"></a>业务场景</h1><p>随着公司业务的发展，数据量的不断增长，以前各业务线对于搜索数据维护的能力显得有些捉襟见肘。同时由于早期没有进行架构方面的规划，业务线各自维护es作为搜索引擎，随之而来的问题如单点、版本不统一、没有很好的规划分片数据等，对于高可用以及实时响应带来了挑战，同时也增加了运维成本。</p>
<p>目前有些数据搜索依旧在数据库进行的，随着数据量增加以及查询维度的提升，单个数据库的读写能力有限，未来存在分片的可能性，对数据一片片查询，对数据库返回结果在内存聚合的方式，缺点显而易见，同时增加了开发的复杂性，对数据库的性能也带来了不必要的负担。</p>
<p>基于上述的原因，遂决定建立通用的搜索服务来为业务线提供统一的入口。同时提供了高可用、以及良好的响应时间。</p>
<h1 id="随之而来的问题"><a href="#随之而来的问题" class="headerlink" title="随之而来的问题"></a>随之而来的问题</h1><p>数据更新是一个比较重要的问题，之前解决的方案是每次有数据修改，同时修改对应记录的<code>sync_status</code>状态，然后由定时任务扫描sync_status，将修改记录同步到es。定时任务存在的问题：</p>
<ul>
<li>sync_status = 0查询会进行全表扫描，即使创建索引效率不会有大的提升</li>
<li>定时任务频率问题，同步频率过低，会造成数据可搜索窗口期过大，频率过高，加上全表扫描会对数据库带来过大的压力</li>
</ul>
<p>减少对业务的影响，要做到零耦合，不侵入现有业务。</p>
<p>当变更数据量比较大的时候，写入es效率限制，可能会导致数据变更到可索引的窗口期增大。</p>
<p>针对同一条数据的修改，可能存在较早修改覆盖最新修改的可能，所以针对一条数据的修改应该是串行的。</p>
<h1 id="开源搜索引擎的选择"><a href="#开源搜索引擎的选择" class="headerlink" title="开源搜索引擎的选择"></a>开源搜索引擎的选择</h1><p>因为之前使用的es搜索引擎，所以在选择上更偏向于该方案。同时也做了简单的调研。</p>
<p>查看了主流的Java搜索引擎方案，主要是solr和es。具体的比较网上文章比较多，就不多做介绍，我总结了我选择es的几点：</p>
<ul>
<li>es更轻量级、更易用，安装、配置方便，不需要依赖第三方包</li>
<li>可以根据服务器数量调整分片位置，只需要前期根据数据量增长，指定合理的分片数</li>
<li>跟其他如logstash、kibana等方便组合，后续可以作为日志平台</li>
</ul>
<h1 id="最终方案"><a href="#最终方案" class="headerlink" title="最终方案"></a>最终方案</h1><p>最终经过考虑采用了如下图的解决方案:</p>
<img src="/2017/12/20/search-system/search_as.png" title="search as">
<p>为了解决定时轮询扫表带来的数据库压力，我们通过定于mysql的binlog，我们采用阿里的<code>canal</code>框架，订阅响应的表的binlog，同样也做到了对业务的零侵入。</p>
<p>解析binlog之后，引入mq来解决上游流量过大给下游服务带来的压力。同时我们es的批量写入功能，防止过多的单个请求。</p>
<p>对于数据覆盖问题，暂时的想法是，记录某条记录的最后修改时间，这个在项目上线后看下效果，是否对性能有影响。</p>
<p>项目采用CQRS架构，将读、写服务分离，将业务复杂性放到Read Server中，Write Server负责数据修改、删除，同时方便以后更好扩展。Read Server对外提供Rest接口，通过Eureka进行客户端负载均衡。Write Server负责消费MQ中的消息进行解析，将数据保存到ES。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>该方案仅为初期设计方案，可能还需要逐步演进。后面出现的问题，会进行更新，该方案也仅供参考。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.finegames.cn/2017/12/20/anemic-domain-model/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王召辉">
      <meta itemprop="description" content="Seven times I have despised my soul">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王召辉">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/20/anemic-domain-model/" itemprop="url">
                  贫血领域模型
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-12-20 21:56:59" itemprop="dateCreated datePublished" datetime="2017-12-20T21:56:59+08:00">2017-12-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-09-10 22:06:34" itemprop="dateModified" datetime="2018-09-10T22:06:34+08:00">2018-09-10</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/DDD/" itemprop="url" rel="index"><span itemprop="name">DDD</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/12/20/anemic-domain-model/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/12/20/anemic-domain-model/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/12/20/anemic-domain-model/" class="leancloud_visitors" data-flag-title="贫血领域模型">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这是已经存在了很长一段时间的反模式之一，但目前似乎正在发生特别的迸发。我们都注意到他们似乎越来越受欢迎。作为一个合适的领域模型的推动者，这不是一件好事。</p>
<p>一个贫血的领域模型的基本症状是，乍一看它看起来像真实的东西。有一些对象，许多以域空间中的名词命名，并且这些对象与真实域模型具有的丰富关系和结构相关联。当你观察这些行为的时候，你会发现这些东西几乎没有任何行为，它们只是一堆的getter和setter。事实上，这些模型经常带有设计规则，表明您不应该将域逻辑放入域对象中。取而代之的是一组服务对象，它们捕获所有的域逻辑，执行所有的计算，并使用结果更新模型对象。这些服务位于领域模型的顶部，并使用域模型作为数据。</p>
<p>这种反模式的根本恐怖之处在于它与面向对象设计的基本思想相悖；也就是将数据和过程结合在一起。贫血的领域模型实际上只是一个过程式的设计，就像我（和Eric）一样，自我们在Smalltalk的早期就一直在斗争的东西。更糟糕的是，许多人认为贫血的对象是真正的对象，因此完全忽略了面向对象设计的要点。</p>
<p>现在，面向对象的语言是很好的，但是我意识到我需要更多的基本论点来反对这种贫血。实质上，贫血领域模型的问题在于它们承担了领域模型的所有成本，而没有产生任何好处。主要成本是对数据库的映射的笨拙，通常会导致整个O/R映射。如果您使用强大的面向对象技术来组织复杂的逻辑，这是值得的。然而，通过将所有行为都导出到服务中，基本上会以事务脚本结束，从而失去域模型带来的好处。</p>
<p>同样值得强调的是，将行为放到域对象中不应该与使用分层来将域逻辑与持久化和表示职责分开的可靠方法相矛盾。应该在域对象中的逻辑是域逻辑 - 验证，计算，业务规则 - 无论你喜欢怎么称呼它。（有些情况下，当您在域对象中放置数据源或表示逻辑时发生争论，但这与我对贫血症的观点正交。）</p>
<p>所有这一切的混乱之处在于，许多面向对象的专家建议在域模型之上建立一层程序服务，以形成服务层。但这并不是一个使域模型无效的参数，实际上服务层主张使用一个服务层与一个行为丰富的域模型相结合。</p>
<p>Eric Evans的优秀的书籍领域驱动设计有以下几层。</p>
<blockquote>
<p>应用层[服务层名称]:定义软件应该做的工作，并指导表达域对象解决问题。该层负责的任务对业务有意义或者与其他系统的应用层进行&gt; 交互所必需的。这层保持薄。它不包含业务规则或知识，但只负责协调任务，并将任务委托给下一层的域对象的协作。它没有反映业务情&gt; 况的状态，但它可以具有反映用户或程序的任务进度的状态。</p>
</blockquote>
<p>域层（或模型层）：负责代表业务的概念、业务情况的信息和业务规则。反映业务情况的状态在这里被控制和使用，即使存储它的技术细节被委托给基础设施。这一层是商业软件的核心。这里的关键点是服务层很薄——所有的关键逻辑都在域层中。他在他的服务模式中重申了这一点：</p>
<blockquote>
<p>现在，更常见的错误是过于轻易地将行为融入适当的对象，逐渐滑向过程式编程。</p>
</blockquote>
<p>我不知道为什么这种反模式如此普遍。我怀疑这是由于许多人没有真正使用合适的领域模型，特别是如果他们来自数据背景。一些技术鼓励它；比如J2EE的Entity Beans，这是我更喜欢POJO领域模型的原因之一。一般来说，您在服务中发现的行为越多，就越有可能抢夺领域模型的好处。如果你所有的逻辑都在服务中，那么你已经失明了。</p>
<h2 id="POJO"><a href="#POJO" class="headerlink" title="POJO"></a>POJO</h2><p>首字母缩略词: 普通旧式Java对象（Plain Old Java Object）。</p>
<p>在谈话中，我们指出了将业务逻辑编码为普通Java对象而不是使用Entity Beans的许多益处。我们想知道为什么人们反对在他们的系统中使用常规对象，并得出结论，这是因为简单的对象缺乏一个奇特的名字。所以我们给了他们一个，并且它很好地被抓住了。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.finegames.cn/2017/12/07/cqrs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王召辉">
      <meta itemprop="description" content="Seven times I have despised my soul">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王召辉">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/07/cqrs/" itemprop="url">
                  CQRS
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-12-07 21:52:19" itemprop="dateCreated datePublished" datetime="2017-12-07T21:52:19+08:00">2017-12-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-09-10 23:52:58" itemprop="dateModified" datetime="2018-09-10T23:52:58+08:00">2018-09-10</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/DDD/" itemprop="url" rel="index"><span itemprop="name">DDD</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/12/07/cqrs/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/12/07/cqrs/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/12/07/cqrs/" class="leancloud_visitors" data-flag-title="CQRS">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>CQRS代表<code>Command Query Responsibility Segregation(命令查询职责分离)</code>。它的核心思想是，您可以使用不同的模型来更新信息，而不是使用您用来读取信息的模型。在某些情况下，这种分离是有价值的，但是要注意，对于大多数系统CQRS会增加风险的复杂性。</p>
<p>人们用于与信息系统交互的主流方法是将其视为CRUD数据存储。我的意思是，我们有一些记录结构的构思模型，我们可以创建新的记录，读取记录，更新已有的记录，并在我们完成这些记录时删除记录。在最简单的情况下，我们的交互都是关于存储和检索这些记录的。</p>
<p>随着我们的需求变得更加复杂，我们逐渐远离这种模式。我们可能希望以不同于记录存储的方式查看信息，可能会将多个记录合并为一个记录，或者通过组合不同位置的信息来形成虚拟记录。在更新方面，我们可能会发现验证规则，只允许存储特定的数据组合，或者甚至可能推断要存储的数据与我们提供的数据不同。</p>
<img src="/2017/12/07/cqrs/cqrs-old.jpg" title="cqrs">
<p>当这发生时，我们开始看到信息的多重表示。当用户与信息进行交互时，他们会使用各种各样的信息，每种信息都是不同的表示形式。开发人员通常会构建自己的概念模型，用它来操纵模型的核心元素。如果你使用的是域模型，那么这通常是域的概念表示。您通常也会将持久性存储尽可能地接近概念模型。</p>
<p>这种多层表示的结构可能会变得非常复杂，但是当人们这样做时，他们仍然将其解析为单一的概念表示，这充当了所有表示之间的概念集成点。</p>
<p>CQRS引入的变化是将该概念模型分解为独立的更新和显示模型，分别称为Command和Query，遵循<a href="https://martinfowler.com/bliki/CommandQuerySeparation.html" target="_blank" rel="noopener">CommandQuerySeparation</a>的词汇表。其基本原理是，对于许多问题，特别是在更复杂的领域中，对于命令和查询拥有相同的概念模型，会导致一个更复杂的模型，但这两者都不太好。</p>

<p>通过单独的模型，我们通常意味着不同的对象模型，可能运行在不同的逻辑过程中，可能在不同的硬件上。Web示例将会看到用户正在查看使用查询模型呈现的网页。如果他们发起更改，将更改发送到单独的命令模型进行处理，则生成的更改将传递给查询模型以呈现更新后的状态。</p>
<p>这里有相当大的变化空间。内存中的模型可以共享相同的数据库，在这种情况下，数据库充当两个模型之间的通信。但是，它们也可能使用单独的数据库，从而有效地将查询端的数据库变为实时<a href="https://martinfowler.com/bliki/ReportingDatabase.html" target="_blank" rel="noopener">ReportingDatabase</a>。在这种情况下，需要在两个模型或其数据库之间建立一些通信机制。</p>
<p>这两个模型可能不是单独的对象模型，可能是相同的对象在其命令端和其查询端具有不同的接口，而与关系数据库中的视图相似。但通常当我听说CQRS时，它们显然是分开的模型。</p>
<p>CQRS自然适合其他一些架构模式。</p>
<ul>
<li>当我们从一个通过CRUD操作的单一表示方式离开时，我们可以很容易地转移到基于任务的UI。</li>
<li>CQRS非常适合<a href="https://martinfowler.com/eaaDev/EventNarrative.html" target="_blank" rel="noopener">基于事件的编程模型</a>。 通常将CQRS系统拆分为与事件协作通信的单独服务。这使得这些服务能够很容易地利用事件的资源。</li>
<li>单独的模型引发了如何难以保持这些模型一致的问题，这提高了使用最终一致性的可能性。</li>
<li>对于许多领域而言，更新时需要大部分逻辑，因此使用<a href="https://martinfowler.com/bliki/EagerReadDerivation.html" target="_blank" rel="noopener">EagerReadDerivation</a>来简化查询方模型可能很有意义。</li>
<li>如果写模型为所有更新生成事件，则可以将读模型构造为<a href="https://martinfowler.com/bliki/EventPoster.html" target="_blank" rel="noopener">EventPosters</a>，从而使它们成为<a href="https://martinfowler.com/bliki/MemoryImage.html" target="_blank" rel="noopener">MemoryImages</a>，从而避免大量数据库交互。</li>
<li>CQRS适用于复杂领域，这种领域也受益于领域驱动设计。</li>
</ul>
<h2 id="何时使用它"><a href="#何时使用它" class="headerlink" title="何时使用它"></a>何时使用它</h2><p>像任何模式一样，CQRS在一些地方是有用的，但在其他地方则不是。许多系统都适合CRUD智能模型，所以应该以这种风格来完成。CQRS对于所有相关的人来说是一个重大的精神飞跃，所以不应该被解决，除非这个好处是值得的。尽管我已经遇到了CQRS的成功使用，但迄今为止，我遇到的大多数情况都不是那么好，CQRS被看作是使软件系统陷入严重困难的重要力量。</p>
<p>特别是CQRS只能用于系统的特定部分（DDD术语中的BoundedContext），而不是整个系统。以这种思维方式，每个有界上下文都需要自己决定如何对其进行建模。</p>
<p>到目前为止，我看到了两个方面的好处。 首先是一些复杂的领域可能更容易通过使用CQRS来解决。然而，我必须强调，CQRS的这种适用性在很大程度上是少数情况。通常，命令和查询之间有足够的重叠，共享模型更容易。在与其不匹配的域上使用CQRS会增加复杂性，从而降低生产力并增加风险。</p>
<p>另一个主要好处是处理高性能应用程序。CQRS允许您将读取和写入的负载分开，允许您独立地扩展。如果您的应用程序在读写之间看到很大的差异，这非常方便。即使没有这一点，您可以对两边应用不同的优化策略。一个例子是使用不同的数据库访问技术来读取和更新。</p>
<p>如果您的域不适合CQRS，但是您需要的查询会增加复杂性或性能问题，请记住，您仍然可以使用ReportingDatabase。CQRS为所有查询使用一个单独的模型。通过报告数据库，您仍然可以将主要系统用于大多数查询，但可以将要求更高的数据转移到报告数据库。</p>
<p>尽管有这些好处，你应该对使用CQRS非常谨慎。许多信息系统与信息库的概念非常吻合，它的更新方式与读取的方式相同，将CQRS添加到这样的系统中会增加相当的复杂性。我确实看到过一些案例，它对生产力造成了很大的拖累，给项目增加了不必要的风险，即使是在有能力的团队的手中。因此，尽管CQRS是一种很好的模式，但要注意，它很难使用，如果你处理不当，你可以很容易地砍掉重要的部分。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.finegames.cn/2017/11/25/dubbo-expose-public-network/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王召辉">
      <meta itemprop="description" content="Seven times I have despised my soul">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王召辉">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/25/dubbo-expose-public-network/" itemprop="url">
                  dubbo暴露公网IP
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-11-25 20:50:05" itemprop="dateCreated datePublished" datetime="2017-11-25T20:50:05+08:00">2017-11-25</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-09-10 22:06:44" itemprop="dateModified" datetime="2018-09-10T22:06:44+08:00">2018-09-10</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/dubbo/" itemprop="url" rel="index"><span itemprop="name">dubbo</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/11/25/dubbo-expose-public-network/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/11/25/dubbo-expose-public-network/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/11/25/dubbo-expose-public-network/" class="leancloud_visitors" data-flag-title="dubbo暴露公网IP">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近需要搭建一套测试环境，主要是协助开发进行跨系统联调。目前系统间调用使用的dubbo框架，测试服务器是在云上，而不是局域网内。这样测试环境就带来两个严重的问题</p>
<ul>
<li>环境隔离</li>
<li>dubbo默认注册一般使用本地地址，当你连接测试环境zk，获取的是云服务器的内网地址，本地是无法调通的</li>
</ul>
<p>关于环境隔离问题，比如开发A注册自己的服务到测试环境的zk，这样带来的问题你的服务已经暴露给测试环境服务，测试环境的rpc调用会轮训到你注册的服务，而你的服务注册到zk的是本地局域网地址，测试环境肯定找不到这个地址，所以调用失败。关于dubbo暴露ip问题<a href="https://github.com/alibaba/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/utils/NetUtils.java" target="_blank" rel="noopener">详见</a></p>
<p>怎么解决这个问题呢？dubbo提供了<code>只订阅</code>功能，不会把本地服务注册到zk上，这样就解决了上面描述的问题。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">"zookeeper://127.0.0.1:2181"</span> <span class="attr">register</span>=<span class="string">"false"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>随之而来的问题，我们不将我们服务注册到zk，那我们本地需要调用这个服务的消费者怎么进行rpc调用呢？同样dubbo为我们提供了直连机制</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">id</span>=<span class="string">"xxxService"</span> <span class="attr">interface</span>=<span class="string">"com.alibaba.xxx.XxxService"</span> <span class="attr">url</span>=<span class="string">"dubbo://localhost:20890"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>在xml中配置的话，可能会比较繁琐，我们可以统一在配置文件中配置，<a href="http://dubbo.io/books/dubbo-user-book/demos/explicit-target.html" target="_blank" rel="noopener">使用方式详见</a></p>
<p>这样我们就解决了环境隔离问题，测试环境不会发现我们本地服务，同样也可以使用测试环境服务进行测试了。</p>
<p>那么接下来看第二个问题，正常情况下我们没办法访问到，测试环境的内网服务，毕竟不是一个局域网内。那么我们自能让服务给我暴露公网ip，我们建立连接。</p>
<p>网上比较多的方式是修改<code>/etc/hosts</code>，这种方案在我们使用<code>kerberos</code>认证的时候会有问题。可以使用<code>dubbo:protocol</code>的host来实现。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">"dubbo"</span> <span class="attr">port</span>=<span class="string">"20880"</span> <span class="attr">host</span>=<span class="string">"123.x.x.x"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>现在我们的问题就都解决了。。。</p>
<p>通过xml配置<code>register=false</code>和<code>host=123.x.x.x</code>，对于代码侵入比较大。可以通过-D参数进行配置：<code>dubbo.protocol.host=123.x.x.x</code>。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.finegames.cn/2017/11/20/mybaits-use-enum/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王召辉">
      <meta itemprop="description" content="Seven times I have despised my soul">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王召辉">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/20/mybaits-use-enum/" itemprop="url">
                  mybatis使用enum
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-11-20 20:47:59" itemprop="dateCreated datePublished" datetime="2017-11-20T20:47:59+08:00">2017-11-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-09-10 22:09:12" itemprop="dateModified" datetime="2018-09-10T22:09:12+08:00">2018-09-10</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/mybatis/" itemprop="url" rel="index"><span itemprop="name">mybatis</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/11/20/mybaits-use-enum/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/11/20/mybaits-use-enum/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/11/20/mybaits-use-enum/" class="leancloud_visitors" data-flag-title="mybatis使用enum">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>项目中经常会遇到一些PO类中的某个字段的取值范围范围是一组固定的值，为了方便期间使用了number来存储这些值。这样会带来的一个问题，当我创建一个PO对象时，这个字段怎么赋值，应该有那些值？通常我们会提供一个enum来维护这个字段的取值范围，随之而来的问题当项目中enum越来越多，或者文档没有更新的情况下，开发人员很难知道，这个字段是不是有enum与之对应，或者是哪个enum与之对应。很多时候我们知道有几种值，我们随手就赋值了一个字面常量值。这就可能出现了莫名其妙的类型。最直接的解决方案，我们在PO字段上直接声明enum类型，就完全避开了错误使用值的情况。</p>
<p>MyBatis官网提供了两种方案，<code>EnumTypeHandler</code>和<code>EnumOrdinalTypeHandler</code>。EnumTypeHandler在数据库中使用<code>VARCHAR</code>存储enum的名字。<code>EnumOrdinalTypeHandler</code>在数据库使用<code>NUMBER</code>或<code>DOUBLE</code>存储enum的索引。</p>
<p>我们更想的是在表中存储<code>NUMBER</code>类型，所以<code>EnumOrdinalTypeHandler</code>更适合我们的需求。<code>EnumOrdinalTypeHandler</code>存储是enum的索引，但是如果我们在enum中想使用自己的code，而不是enum本身的索引，要怎么去做呢？根据MyBatis官网文档我们可以自定义类型处理器来试下，下面是自定义处理器的使用方法。</p>
<p>既然我们的目的是想使用自定义的code存储到表中，所以首先我们应该强制我们的enum类型应该有对应的code字段，我们通过在enum中实现接口来实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EnumCode</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回枚举值代码</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getCode</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面我们定义了一个接口<code>EnumCode</code>它值定义了一个方法就是返回<code>code</code>。在我们的enum中实现该接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> PlatformEnum implements EnumCode &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 安卓</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ANDROID(<span class="number">0</span>),</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * IOS</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    IOS(<span class="number">1</span>),</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 微信小游戏</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    WECHAT(<span class="number">2</span>),</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * H5</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    H5(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> code;</span><br><span class="line"></span><br><span class="line">    PlatformEnum(<span class="keyword">int</span> code) &#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来就是实现类型处理器，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnumCodeTypeHandler</span> <span class="keyword">extends</span> <span class="title">BaseTypeHandler</span>&lt;<span class="title">EnumCode</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Class&lt;EnumCode&gt; type;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EnumCodeTypeHandler</span><span class="params">(@NonNull Class&lt;EnumCode&gt; type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNonNullParameter</span><span class="params">(PreparedStatement ps, <span class="keyword">int</span> i, EnumCode parameter, JdbcType jdbcType)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        ps.setByte(i, (<span class="keyword">byte</span>) parameter.getCode());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EnumCode <span class="title">getNullableResult</span><span class="params">(ResultSet rs, String columnName)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = rs.getByte(columnName);</span><br><span class="line">        <span class="keyword">if</span> (rs.wasNull()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getValuedEnum(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EnumCode <span class="title">getNullableResult</span><span class="params">(ResultSet rs, <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> code = rs.getByte(columnIndex);</span><br><span class="line">        <span class="keyword">return</span> rs.wasNull() ? <span class="keyword">null</span> : getValuedEnum(code);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EnumCode <span class="title">getNullableResult</span><span class="params">(CallableStatement cs, <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> code = cs.getByte(columnIndex);</span><br><span class="line">        <span class="keyword">return</span> cs.wasNull() ? <span class="keyword">null</span> : getValuedEnum(code);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转换为&#123;<span class="doctag">@link</span> EnumCode&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> EnumCode <span class="title">getValuedEnum</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">        EnumCode[] codes = type.getEnumConstants();</span><br><span class="line">        <span class="keyword">for</span> (EnumCode em : codes) &#123;</span><br><span class="line">            <span class="keyword">if</span> (em.getCode() == value) &#123;</span><br><span class="line">                <span class="keyword">return</span> em;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                <span class="string">"Cannot convert "</span> + value + <span class="string">" to "</span> + type.getSimpleName() + <span class="string">" by value."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上就完成我们自定义的类型处理器。接下来就看看我们如果在xml中使用类型处理器：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"platform"</span> <span class="attr">jdbcType</span>=<span class="string">"TINYINT"</span> <span class="attr">property</span>=<span class="string">"platform"</span> <span class="attr">typeHandler</span>=<span class="string">"cn.finegames.commons.integrate.EnumCodeTypeHandler"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"platform != null"</span>&gt;</span></span><br><span class="line">    #&#123;platform,jdbcType=TINYINT, typeHandler=cn.finegames.commons.integrate.EnumCodeTypeHandler&#125;,</span><br><span class="line"><span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在声明<code>resultMap</code>和进行插入、修改时使用上面形式就可以了。</p>
<p><code>还有一种比较常用的情况，如果在where语句中使用enum，而不是通过方法传入值该怎么处理？</code>这种情况我也搞了很久，查了很多资料，终于找到对应的方案…</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">token_type = $&#123;@cn.xxx.TokenTypeEnum@ACCESS.getCode()&#125;</span><br></pre></td></tr></table></figure>
<p>使用<code>OGNL</code>表达式就可以了。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.finegames.cn/2017/11/18/spring-cron-with-yml/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王召辉">
      <meta itemprop="description" content="Seven times I have despised my soul">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王召辉">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/18/spring-cron-with-yml/" itemprop="url">
                  Spring Boot使用yml格式cron表达式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-11-18 20:45:39" itemprop="dateCreated datePublished" datetime="2017-11-18T20:45:39+08:00">2017-11-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-09-10 22:06:59" itemprop="dateModified" datetime="2018-09-10T22:06:59+08:00">2018-09-10</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/spring-boot/" itemprop="url" rel="index"><span itemprop="name">spring boot</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/11/18/spring-cron-with-yml/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/11/18/spring-cron-with-yml/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/11/18/spring-cron-with-yml/" class="leancloud_visitors" data-flag-title="Spring Boot使用yml格式cron表达式">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>通常在spring工程中我们会将定时任务的cron表达式配置在properties中，当项目迁移到spring boot下时，spring boot提供了更为便利的yml配置文件。关于yml的使用以及优势我们不做过多的讨论。本篇文章讨论下在yml中配置cron程序的使用问题。</p>
<p>因为我们使用yml文件所以之前类似于<code>@Schedule(${app.cron})</code>肯定是行不通的，yml配置根本不支持这种形式。这就比较难办了，我们怎么才能再次有效的使用el表达式赋值给我们的cron字段呢？</p>
<p>首先为了能获得到该值，我们需要定义一个类，并使用成员变量来接收这些值。</p>
<p>例如我们的yml文件内容如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">app:</span></span><br><span class="line"><span class="attr">  cron:</span> <span class="number">0</span> <span class="number">0</span> <span class="number">12</span> <span class="string">*</span> <span class="string">*</span> <span class="string">?</span></span><br></pre></td></tr></table></figure>
<p>我们定义一个Java Config的类来接收该配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configurable</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(<span class="string">"app"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CronConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String cron;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">cron</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.cron;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCron</span><span class="params">(String cron)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.cron = cron;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重点就是在我们的<code>@Bean</code>上。这样我们就可以在我们的定时任务cron表达式使用该值了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySchedule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schedule</span>(cron=<span class="string">"#&#123;@cron&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>感觉是麻烦了一些😆，也可以使用properties、yml结合的方式。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpeg"
                alt="王召辉" />
            
              <p class="site-author-name" itemprop="name">王召辉</p>
              <p class="site-description motion-element" itemprop="description">Seven times I have despised my soul</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">14</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">18</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/metogefun" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="wangzhaohui:alsace37@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 – <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">王召辉</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Muse</a> v6.4.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  



  
  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="true"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three-waves.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.1"></script>



  

  
    <script id="dsq-count-scr" src="https://wang.disqus.com/count.js" async></script>
  

  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script>
    
    function showTime(Counter) {
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url: { "$in": entries } }) })
        .done(function ({ results }) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.url;
            var time = item.time;
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function ({ responseJSON }) {
          console.log("LeanCloud Counter Error: " + responseJSON.code + " " + responseJSON.error);
        });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + "KjM5GKUauwUdpVDe8RXfpGnO-gzGzoHsz")
        .done(function ({ api_server }) {
          var Counter = function (method, url, data) {
            return $.ajax({
              method: method,
              url: `https://${api_server}/1.1${url}`,
              headers: {
                'X-LC-Id': "KjM5GKUauwUdpVDe8RXfpGnO-gzGzoHsz",
                'X-LC-Key': "liGRnr6Nhx1ebAHsJ4qcpWkE",
                'Content-Type': 'application/json',
              },
              data: data,
            });
          };
          
          if ($('.post-title-link').length >= 1) {
            showTime(Counter);
          }
          
        })
    });
  </script>



  

  

  

  
  

  

  

  

  

  

</body>
</html>
